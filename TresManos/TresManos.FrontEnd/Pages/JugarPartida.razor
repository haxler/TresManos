@page "/partida/{PartidaId:int}/jugar"
@inherits JugarPartidaBase

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6">
    <MudPaper Elevation="3" Class="pa-6">
        <!-- Título -->
        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
            Piedra, Papel o Tijera
        </MudText>

        @if (IsLoading)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mx-auto d-block mt-6" />
            <MudText Align="Align.Center" Class="mt-3">Cargando partida...</MudText>
        }
        else if (Partida == null)
        {
            <MudAlert Severity="Severity.Error" Class="mt-4">
                No se pudo cargar la información de la partida.
            </MudAlert>
        }
        else if (Partida.Estado == "FINALIZADA")
        {
            <MudAlert Severity="Severity.Success" Class="mt-4">
                <MudText Typo="Typo.h6">¡Partida finalizada!</MudText>
                <MudText>Ganador: <strong>@Partida.NombreGanador</strong></MudText>
            </MudAlert>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Class="mt-4"
                       OnClick="@(() => Nav.NavigateTo($"/partida/{PartidaId}/detalles"))">
                Ver Detalles de la Partida
            </MudButton>
        }
        else
        {
            <!-- Selección de movimientos -->
            <MudGrid Class="mt-6">
                <!-- Jugador 1 -->
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="2" Class="pa-4" Style="border: 2px solid #1976d2;">
                        <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Primary" GutterBottom="true">
                            Jugador 1
                        </MudText>
                        <MudText Typo="Typo.body1" Align="Align.Center" GutterBottom="true">
                            @Partida.NombreJugador1
                        </MudText>

                        <MudStack Spacing="3" Class="mt-4">
                            <MudButton Variant="@(MovimientoJugador1 == "P" ? Variant.Filled : Variant.Outlined)"
                                       Color="Color.Primary"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.Circle"
                                       OnClick="@(() => MovimientoJugador1 = "P")"
                                       Disabled="@IsSubmitting">
                                PIEDRA
                            </MudButton>

                            <MudButton Variant="@(MovimientoJugador1 == "A" ? Variant.Filled : Variant.Outlined)"
                                       Color="Color.Primary"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.Description"
                                       OnClick="@(() => MovimientoJugador1 = "A")"
                                       Disabled="@IsSubmitting">
                                PAPEL
                            </MudButton>

                            <MudButton Variant="@(MovimientoJugador1 == "T" ? Variant.Filled : Variant.Outlined)"
                                       Color="Color.Primary"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.ContentCut"
                                       OnClick="@(() => MovimientoJugador1 = "T")"
                                       Disabled="@IsSubmitting">
                                TIJERA
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <!-- Jugador 2 -->
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="2" Class="pa-4" Style="border: 2px solid #d32f2f;">
                        <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Error" GutterBottom="true">
                            Jugador 2
                        </MudText>
                        <MudText Typo="Typo.body1" Align="Align.Center" GutterBottom="true">
                            @Partida.NombreJugador2
                        </MudText>

                        <MudStack Spacing="3" Class="mt-4">
                            <MudButton Variant="@(MovimientoJugador2 == "P" ? Variant.Filled : Variant.Outlined)"
                                       Color="Color.Error"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.Circle"
                                       OnClick="@(() => MovimientoJugador2 = "P")"
                                       Disabled="@IsSubmitting">
                                PIEDRA
                            </MudButton>

                            <MudButton Variant="@(MovimientoJugador2 == "A" ? Variant.Filled : Variant.Outlined)"
                                       Color="Color.Error"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.Description"
                                       OnClick="@(() => MovimientoJugador2 = "A")"
                                       Disabled="@IsSubmitting">
                                PAPEL
                            </MudButton>

                            <MudButton Variant="@(MovimientoJugador2 == "T" ? Variant.Filled : Variant.Outlined)"
                                       Color="Color.Error"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.ContentCut"
                                       OnClick="@(() => MovimientoJugador2 = "T")"
                                       Disabled="@IsSubmitting">
                                TIJERA
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <!-- Botón Enviar Jugada -->
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Default" 
                       FullWidth="true" 
                       Size="Size.Large"
                       Class="mt-6"
                       OnClick="JugarRonda"
                       Disabled="@(IsSubmitting || string.IsNullOrEmpty(MovimientoJugador1) || string.IsNullOrEmpty(MovimientoJugador2))">
                @if (IsSubmitting)
                {
                    <MudProgressCircular Size="@Size.Small" Indeterminate="true" Class="me-2" />
                    <span>Procesando...</span>
                }
                else
                {
                    <span>Enviar Jugada</span>
                }
            </MudButton>

            <!-- Resultado -->
            <MudPaper Elevation="2" Class="pa-4 mt-6 text-center">
                <MudText Typo="Typo.h6" GutterBottom="true">Resultado</MudText>
                
                @if (MostrandoResultado)
                {
                    @if (UltimoResultado == "E")
                    {
                        <MudText Typo="Typo.h5" Color="Color.Default">¡Empate!</MudText>
                        <MudText Typo="Typo.body2" Class="mt-2">Ambos eligieron @ObtenerNombreMovimiento(UltimoMovimientoJ1)</MudText>
                    }
                    else if (UltimoResultado == "1")
                    {
                        <MudText Typo="Typo.h5" Color="Color.Success">¡@Partida.NombreJugador1 ganó la ronda!</MudText>
                        <MudText Typo="Typo.body2" Class="mt-2">
                            @ObtenerNombreMovimiento(UltimoMovimientoJ1) vence a @ObtenerNombreMovimiento(UltimoMovimientoJ2)
                        </MudText>
                    }
                    else if (UltimoResultado == "2")
                    {
                        <MudText Typo="Typo.h5" Color="Color.Success">¡@Partida.NombreJugador2 ganó la ronda!</MudText>
                        <MudText Typo="Typo.body2" Class="mt-2">
                            @ObtenerNombreMovimiento(UltimoMovimientoJ2) vence a @ObtenerNombreMovimiento(UltimoMovimientoJ1)
                        </MudText>
                    }

                    <!-- Marcador -->
                    <MudDivider Class="my-3" />
                    <MudText Typo="Typo.body1">
                        <strong>@Partida.NombreJugador1:</strong> @RondasGanadasJ1 | 
                        <strong>@Partida.NombreJugador2:</strong> @RondasGanadasJ2
                    </MudText>
                }
                else
                {
                    <MudText Typo="Typo.body1" Color="Color.Secondary">Esperando jugadas...</MudText>
                }
            </MudPaper>

            <!-- Historial de rondas -->
            @if (Rondas != null && Rondas.Any())
            {
                <MudDivider Class="my-6" />
                <MudText Typo="Typo.h6" GutterBottom="true">Historial de Rondas</MudText>
                
                <MudTable Items="@Rondas" Hover="true" Striped="true" Dense="true" Elevation="2">
                    <HeaderContent>
                        <MudTh>Ronda</MudTh>
                        <MudTh>@Partida.NombreJugador1</MudTh>
                        <MudTh>@Partida.NombreJugador2</MudTh>
                        <MudTh>Resultado</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Ronda">@context.NumeroRonda</MudTd>
                        <MudTd DataLabel="Jugador 1">@ObtenerNombreMovimiento(context.MovimientoJugador1)</MudTd>
                        <MudTd DataLabel="Jugador 2">@ObtenerNombreMovimiento(context.MovimientoJugador2)</MudTd>
                        <MudTd DataLabel="Resultado">
                            @if (context.Resultado == "E")
                            {
                                @* <MudChip Color="Color.Default" Size="Size.Small">Empate</MudChip> *@
                            }
                            else if (context.Resultado == "1")
                            {
                                @* <MudChip Color="Color.Success" Size="Size.Small">Ganó @Partida.NombreJugador1</MudChip> *@
                            }
                            else
                            {
                                @* <MudChip Color="Color.Success" Size="Size.Small">Ganó @Partida.NombreJugador2</MudChip> *@
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        }
    </MudPaper>
</MudContainer>